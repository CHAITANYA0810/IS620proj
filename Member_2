
-- Drop sequences with correct names
DROP SEQUENCE Category_Seq;
DROP SEQUENCE Product_Seq;
DROP SEQUENCE Update_Seq;
DROP SEQUENCE Report_Seq;

-- Create the sequence Category_Seq
CREATE SEQUENCE Category_Seq START WITH 1 INCREMENT BY 1;
-- Create the sequence Product_Seq
CREATE SEQUENCE Product_Seq START WITH 1 INCREMENT BY 1;
-- Create the sequence Update_Seq
CREATE SEQUENCE Update_Seq START WITH 1 INCREMENT BY 1;
-- Create the sequence Report_Seq
CREATE SEQUENCE Report_Seq START WITH 1 INCREMENT BY 1;

-- Procedure to add a new product category
CREATE OR REPLACE PROCEDURE Add_Category(
    p_ProductCategory_Name IN VARCHAR2,
    p_ProductCategory_Desc IN VARCHAR2
) AS
BEGIN
    INSERT INTO Product_Category(ProductCategory_ID, ProductCategory_Name, ProductCategory_Desc)
    VALUES (Category_Seq.NEXTVAL, p_ProductCategory_Name, p_ProductCategory_Desc);
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Product category added successfully');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;

-- Procedure to add a new product
CREATE OR REPLACE PROCEDURE Add_Product(
    p_Product_Name IN VARCHAR2,
    p_Avail_Quant IN NUMBER,
    p_UnitPrice IN NUMBER,
    p_ProductCategory_Name IN VARCHAR2
) AS
    v_ProductCategory_ID NUMBER;
BEGIN
    -- Find the category ID using the category name
    SELECT ProductCategory_ID INTO v_ProductCategory_ID
    FROM Product_Category
    WHERE ProductCategory_Name = p_ProductCategory_Name;

    -- Insert the product information
    INSERT INTO Products(Product_ID, Product_Name, Avail_Quant, Unitprice, ProductCategory_ID)
    VALUES (Product_Seq.NEXTVAL, p_Product_Name, p_Avail_Quant, p_UnitPrice, v_ProductCategory_ID);
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Product added successfully');
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Error: Category not found.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;

-- Procedure to update product inventory after an order
CREATE OR REPLACE PROCEDURE Update_Inventory(
    p_ProductName IN VARCHAR2,
    p_Quantity IN NUMBER
) AS
BEGIN
    UPDATE Products
    SET Avail_Quant = Avail_Quant - p_Quantity
    WHERE Product_Name = p_ProductName;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Inventory updated successfully');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;

-- Procedure to report available inventory
CREATE OR REPLACE PROCEDURE Report_Inventory AS
BEGIN
    FOR category IN (
        SELECT pc.ProductCategory_Name, SUM(p.Avail_Quant) AS TotalQuantity
        FROM Product_Category pc
        LEFT JOIN Products p ON pc.ProductCategory_ID = p.ProductCategory_ID
        GROUP BY pc.ProductCategory_Name
    ) LOOP
        DBMS_OUTPUT.PUT_LINE('Category: ' || category.ProductCategory_Name);
        DBMS_OUTPUT.PUT_LINE('Total Quantity: ' || category.TotalQuantity);
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
